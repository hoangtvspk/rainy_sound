default_platform(:android)

platform :android do
  desc "Build and deploy Android app to Firebase and Play Store"
  lane :deploy do |options|
    env = options[:environment] || "dev"
    gradle_task = env == "prod" ? "assembleRelease" : "assembleDebug"
    firebase_app_id = options[:firebase_app_id] || ENV["FIREBASE_APP_ID"] 

    UI.message("ğŸš€ Deploying Android app for environment: #{env}")

    # Láº¥y version vÃ  build number
    version_number = get_android_version_number
    build_number = get_android_build_number

    # Cáº­p nháº­t version trong build.gradle
    gradle_file_path = "../app/build.gradle"
    gradle_content = File.read(gradle_file_path)
    
    # Cáº­p nháº­t versionName
    gradle_content = gradle_content.gsub(
      /versionName\s+"[^"]+"/,
      "versionName \"#{version_number}\""
    )
    
    # Cáº­p nháº­t versionCode
    gradle_content = gradle_content.gsub(
      /versionCode\s+\d+/,
      "versionCode #{build_number}"
    )
    
    File.write(gradle_file_path, gradle_content)

    begin
        gradle(task: gradle_task)
    rescue => e
        UI.error("âŒ Failed to build Android app: #{e.message}")
        next
    end

    relative = "../../"
    absolute = File.expand_path(relative, __dir__)

    UI.message "ğŸ“ __dir__ = #{__dir__}"
    UI.message "ğŸ“ Dir.pwd = #{Dir.pwd}"
    UI.message "ğŸ“ '../../' resolved = #{absolute}"

    path = File.expand_path("../../build/app/outputs/bundle", __dir__)
    UI.message "ğŸ“‚ ../../build/app/outputs/bundle: #{path}"

    if File.directory?(path)
      UI.message "ğŸ“ Contents of #{path}:"
      Dir.entries(path).each { |entry| UI.message "  - #{entry}" }
    else
      UI.error "âŒ Folder not found: #{path}"
    end


    pathRelease = File.expand_path("../../build/app/outputs/bundle/#{env}Release", __dir__)
    UI.message "ğŸ“‚ ../../build/app/outputs/bundle/#{env}Release: #{pathRelease}"

    if File.directory?(pathRelease)
      UI.message "ğŸ“ Contents of #{pathRelease}:"
      Dir.entries(pathRelease).each { |entry| UI.message "  - #{entry}" }
    else
      UI.error "âŒ Folder not found: #{pathRelease}"
    end

    

    aab_path = File.expand_path("../../build/app/outputs/bundle/#{env}Release/app-#{env}-release.aab", __dir__)
    apk_path = File.expand_path("../../build/app/outputs/flutter-apk/app-#{env}-release.apk", __dir__)
    UI.message("ğŸ“¦ Using AAB path: #{aab_path}")
    UI.message("ğŸ“¦ Using APK path: #{apk_path}")

    if firebase_app_id && File.exist?(apk_path)
      begin
        firebase_app_distribution(
          app: firebase_app_id,
          android_artifact_path: apk_path,
          android_artifact_type: "APK",
          groups: "beta-testers",
          release_notes: "Deploying #{env} build - #{Time.now.strftime('%Y-%m-%d %H:%M:%S')}"
        )
        UI.success("âœ… Uploaded to Firebase App Distribution successfully")
      rescue => e
        UI.error("âŒ Failed to upload to Firebase: #{e.message}")
      end
    else
      UI.error("âš ï¸ Firebase App ID not set or AAB not found, skipping Firebase upload.")
    end

    # ğŸ“¤ Google Play Upload
    json_key_file = File.expand_path("../../google-play-service-account.json", __dir__)

    begin
      track = env == "prod" ? "production" : "internal"
      UI.message("Debug info:")
      UI.message("Current directory: #{Dir.pwd}")
      UI.message("JSON file path: #{json_key_file}")
      UI.message("JSON file exists? #{File.exist?(json_key_file)}")
      UI.message("JSON file content:")
      UI.message(File.read(json_key_file))
      
      supply(
        track: track,
        aab: aab_path,
        json_key: json_key_file
      )
      UI.success("âœ… Uploaded to Play Store #{track} track successfully")
    rescue => e
      UI.error("âŒ Failed to upload to Play Store: #{e.message}")
      UI.error("Full error: #{e.backtrace.join("\n")}")
    end

    UI.success("ğŸ‰ Android deploy lane completed")
  end

  private_lane :get_android_version_number do 
    # Äá»c version tá»« build.gradle
    gradle_path = "../app/build.gradle"
    unless File.exist?(gradle_path)
      UI.error("âŒ build.gradle not found")
      next nil
    end
  
    gradle_content = File.read(gradle_path)
    version_match = gradle_content.match(/versionName\s*[=]?\s*["']([^"']+)["']/)
    
    if version_match
      version = version_match[1]
      UI.message("ğŸ“± Android Version from build.gradle: #{version}")
      next version
    else
      UI.error("âŒ Could not find versionName in build.gradle")
      next nil
    end
  end

  private_lane :get_android_build_number do 
    # Äá»c build number tá»« build.gradle
    gradle_path = "../app/build.gradle"
    unless File.exist?(gradle_path)
      UI.error("âŒ build.gradle not found")
      next 1
    end
  
    gradle_content = File.read(gradle_path)
    build_match = gradle_content.match(/versionCode\s+(\d+)/)
    
    if build_match
      current_build = build_match[1].to_i
      new_build = current_build + 1
      UI.message("ğŸ“± Android Build number: #{new_build}")
      next new_build
    else
      UI.error("âŒ Could not find versionCode in build.gradle")
      next 1
    end
  end
end